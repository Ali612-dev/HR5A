<!-- Enhanced Loading State -->
<app-loading-data
  *ngIf="isLoading"
  [message]="loadingMessage"
  [showSubtitle]="true"
  [spinnerDiameter]="60">
</app-loading-data>

<!-- Enhanced Error State (only for real errors, not empty states) -->
<div *ngIf="error && !isLoading && !isEmptyStateError()" class="error-container">
  <div class="error-content">
    <mat-icon class="error-icon">error_outline</mat-icon>
    <div class="error-text">
      <h5 class="error-title">{{ 'Error' | translate }}</h5>
      <p class="error-message">{{ error | translate }}</p>
    </div>
    <div class="error-actions">
      <button mat-raised-button color="warn" (click)="retry.emit()">
        <mat-icon>refresh</mat-icon>
        {{ 'Retry' | translate }}
      </button>
    </div>
  </div>
</div>

<!-- Desktop Material Table View -->
<div *ngIf="!isLoading && (!error || isEmptyStateError()) && !isMobile" class="material-table-container">
  <div class="table-wrapper">
    <table mat-table [dataSource]="dataSource" matSort class="material-table">
      
      <!-- Dynamic Columns -->
      <ng-container *ngFor="let column of columns" [matColumnDef]="column.key">
        <ng-container *ngIf="column.sortable !== false">
          <th mat-header-cell 
              *matHeaderCellDef
              [mat-sort-header]="column.key"
              [class]="'text-' + getColumnAlign(column)">
            <ng-container *ngIf="column.headerTemplate; else defaultHeader">
              <ng-container *ngTemplateOutlet="column.headerTemplate; context: { $implicit: column }"></ng-container>
            </ng-container>
            <ng-template #defaultHeader>
              {{ column.label | translate }}
            </ng-template>
          </th>
        </ng-container>
        <ng-container *ngIf="column.sortable === false">
          <th mat-header-cell
              *matHeaderCellDef
              [class]="'text-' + getColumnAlign(column)">
            <ng-container *ngIf="column.headerTemplate; else defaultHeaderNoSort">
              <ng-container *ngTemplateOutlet="column.headerTemplate; context: { $implicit: column }"></ng-container>
            </ng-container>
            <ng-template #defaultHeaderNoSort>
              {{ column.label | translate }}
            </ng-template>
          </th>
        </ng-container>
        <td mat-cell *matCellDef="let row" 
            [class]="'text-' + getColumnAlign(column)"
            (click)="onRowClick(row)"
            [style.cursor]="rowClick.observed ? 'pointer' : 'default'">
          <ng-container *ngIf="column.cellTemplate; else defaultCell">
            <ng-container *ngTemplateOutlet="column.cellTemplate; context: { $implicit: row, column: column }"></ng-container>
          </ng-container>
          <ng-template #defaultCell>
            {{ getCellValue(row, column.key) }}
          </ng-template>
        </td>
      </ng-container>

      <!-- Actions Column -->
      <ng-container *ngIf="showActions && actions.length > 0" matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef class="text-center">
          {{ 'Actions' | translate }}
        </th>
        <td mat-cell *matCellDef="let row" class="text-center actions-cell">
          <div class="action-buttons">
            <ng-container *ngFor="let action of actions">
              <button *ngIf="shouldShowAction(action, row)"
                      mat-icon-button 
                      [color]="action.color || 'primary'"
                      (click)="onActionClick(action, row, $event)"
                      [title]="action.label | translate">
                <mat-icon>{{ action.icon }}</mat-icon>
              </button>
            </ng-container>
          </div>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;" 
          [class.row-clickable]="rowClick.observed"
          (click)="onRowClick(row)"></tr>
    </table>
  </div>
</div>

<!-- Mobile/Tablet Card View -->
<div *ngIf="!isLoading && (!error || isEmptyStateError()) && isMobile" class="mobile-cards-container">
  <ng-container *ngIf="mobileCardTemplate; else defaultMobileCard">
    <ng-container *ngFor="let item of data; trackBy: trackBy; let i = index">
      <ng-container *ngTemplateOutlet="mobileCardTemplate; context: { $implicit: item, index: i }"></ng-container>
    </ng-container>
  </ng-container>
  <ng-template #defaultMobileCard>
    <mat-card *ngFor="let row of data; trackBy: trackBy" class="data-table-card" (click)="onRowClick(row)">
      <mat-card-content>
        <div *ngFor="let column of columns" class="card-detail">
          <strong>{{ column.label | translate }}:</strong>
          <span *ngIf="!column.cellTemplate">{{ getCellValue(row, column.key) }}</span>
          <ng-container *ngIf="column.cellTemplate">
            <ng-container *ngTemplateOutlet="column.cellTemplate; context: { $implicit: row, column: column }"></ng-container>
          </ng-container>
        </div>
      </mat-card-content>
      <mat-card-actions *ngIf="showActions && actions.length > 0" class="card-actions">
        <ng-container *ngFor="let action of actions">
          <button *ngIf="shouldShowAction(action, row)"
                  mat-icon-button 
                  [color]="action.color || 'primary'"
                  (click)="onActionClick(action, row, $event)"
                  [title]="action.label | translate">
            <mat-icon>{{ action.icon }}</mat-icon>
          </button>
        </ng-container>
      </mat-card-actions>
    </mat-card>
  </ng-template>
</div>

<!-- Empty State -->
<app-empty-data
  *ngIf="!isLoading && (!error || isEmptyStateError()) && data.length === 0"
  [title]="emptyMessage"
  [description]="emptyDescription"
  icon="inbox">
</app-empty-data>

