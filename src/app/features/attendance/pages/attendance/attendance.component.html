<div class="attendance-container">
  <div class="container-fluid py-3 py-md-4">
    <!-- Header -->
    <div class="page-header">
      <div class="header-left">
        <button class="btn btn-ghost me-3" (click)="goBack()">
          <fa-icon [icon]="faArrowLeft" class="me-2"></fa-icon>
          {{ 'Back' | translate }}
        </button>
      </div>
      <div class="header-center">
        <fa-icon [icon]="faClock" class="header-icon"></fa-icon>
        <h2 class="page-title">{{ 'DailyAttendance' | translate }}</h2>
      </div>
      <div class="header-actions">
        <button class="btn btn-secondary" routerLink="/attendance/add">
          <fa-icon [icon]="faPlus" class="me-1"></fa-icon>
          <span class="desktop-text">{{ 'AddAttendance' | translate }}</span>
          <span class="mobile-text">{{ 'AddAttendance' | translate }}</span>
        </button>
        <button class="btn btn-secondary" (click)="toggleFilter()">
          <fa-icon [icon]="faFilter" class="me-1"></fa-icon> {{ 'Filter' | translate }}
        </button>
        <button class="btn btn-secondary" (click)="onViewAllOnMap()">
          <fa-icon [icon]="faMapMarkerAlt" class="me-1"></fa-icon>
          <span class="desktop-text">{{ 'ViewAllOnMap' | translate }}</span>
          <span class="mobile-text">{{ 'ViewAllOnMap' | translate }}</span>
        </button>
      </div>
    </div>

    <!-- Desktop Filtering -->
    <div *ngIf="!isFilterCollapsed && !isMobile" class="glass-card filter-card">
      <h5 class="mb-2">{{ 'Filters' | translate }}</h5>
      <form [formGroup]="filterForm" (ngSubmit)="onFilter()" class="filters-container">
        <input type="date" class="form-control" formControlName="date" [placeholder]="'Date' | translate">
        <input type="text" class="form-control" formControlName="employeeName"
          [placeholder]="'EmployeeName' | translate">
        <div class="filter-buttons">
          <button type="submit" class="btn btn-primary">{{ 'Filters' | translate }}</button>
          <button type="button" class="btn btn-secondary" (click)="onResetFilters()">{{ 'Reset' | translate }}</button>
        </div>
      </form>
    </div>

    <!-- Attendance Table -->
    <app-material-data-table [data]="filteredAttendances()" [columns]="tableColumns" [actions]="tableActions"
      [isLoading]="store.isLoading()" [error]="store.error()" [sortField]="store.request().sortField || ''"
      [sortOrder]="store.request().sortOrder || 'asc'" [emptyMessage]="'NoAttendanceRecords'"
      [emptyDescription]="'NoAttendanceRecordsDescription'" [loadingMessage]="'LoadingAttendance'"
      (sortChange)="onSort($event)" (retry)="onRetryLoadAttendances()">

      <!-- Templates for custom cell rendering -->
      <ng-template #employeeNameTemplate let-row>
        <div class="employee-name-cell d-flex align-items-center justify-content-center flex-nowrap gap-2">
          <button class="btn-calc-hours" (click)="viewMonthlyHours(row, $event)"
            [title]="'CalculateMonthlyHours' | translate">
            <fa-icon [icon]="faCalculator"></fa-icon>
          </button>
          <span class="text-truncate">{{ row.employeeName }}</span>
        </div>
      </ng-template>

      <ng-template #dateTemplate let-row>
        <div class="d-flex align-items-center justify-content-center">
          <span *ngIf="!isMultipleDates(row)">
            {{ row.date | date: 'dd/MM/yyyy' }}
          </span>
          <div *ngIf="isMultipleDates(row)" style="text-align: center; line-height: 1.5;">
            <div style="font-size: 0.9em; margin-bottom: 4px; white-space: nowrap;">
              <span style="color: #666; font-weight: 500;">{{ 'Attendance' | translate }}:</span> {{ getCheckInDate(row)
              }}
            </div>
            <div style="font-size: 0.9em; white-space: nowrap;">
              <span style="color: #666; font-weight: 500;">{{ 'Departure' | translate }}:</span> {{ getCheckOutDate(row)
              }}
            </div>
          </div>
        </div>
      </ng-template>

      <ng-template #timeInTemplate let-row>
        <div class="d-flex align-items-center justify-content-center">
          <span>{{ row.firstCheckIn | date: 'shortTime' }}</span>
        </div>
      </ng-template>

      <ng-template #timeOutTemplate let-row>
        <div class="d-flex align-items-center justify-content-center">
          <span>{{ row.lastCheckOut | date: 'shortTime' }}</span>
        </div>
      </ng-template>

      <ng-template #statusTemplate let-row>
        <div class="d-flex align-items-center justify-content-center">
          <span [class]="row.status === 'Present' ? 'badge badge-success' : 'badge badge-danger'">
            {{ row.status }}
          </span>
        </div>
      </ng-template>

      <ng-template #sessionsTemplate let-row>
        <div class="d-flex align-items-center justify-content-center">
          <button *ngIf="row.sessionsCount > 1" class="btn btn-sm btn-info sessions-badge"
            (click)="viewSessions(row, $event)">
            {{ row.sessionsCount }} {{ 'Sessions' | translate }}
          </button>
          <span *ngIf="row.sessionsCount === 1" class="session-count-single">
            1 {{ 'Session' | translate }}
          </span>
          <span *ngIf="row.sessionsCount === 0" class="text-muted">-</span>
        </div>
      </ng-template>
    </app-material-data-table>

    <!-- Sessions Detail Dialog Template -->
    <ng-template #sessionsDialogTemplate let-data>
      <div class="sessions-dialog">
        <div class="dialog-header">
          <h3>
            <mat-icon>history</mat-icon>
            {{ 'AttendanceSessions' | translate }} - {{ data.employeeName }}
          </h3>
          <p class="subtitle">{{ data.date | date: 'fullDate':undefined:translate.currentLang }}</p>
        </div>

        <div class="dialog-content">
          <div class="sessions-list">
            <div *ngFor="let session of data.sessions; let i = index" class="session-item glass-card">
              <div class="session-num">#{{ i + 1 }}</div>
              <div class="session-info">
                <div class="info-row">
                  <div class="info-group">
                    <label>{{ 'TimeIn' | translate }}</label>
                    <span>{{ session.timeIn | date: 'hh:mm:ss a':undefined:translate.currentLang }}</span>
                  </div>
                  <div class="info-group">
                    <label>{{ 'TimeOut' | translate }}</label>
                    <span>{{ (session.timeOut | date: 'hh:mm:ss a':undefined:translate.currentLang) || '-' }}</span>
                  </div>
                  <div class="info-group">
                    <label>{{ 'Hours' | translate }}</label>
                    <span>{{ session.hours | number: '1.2-2' }}</span>
                  </div>
                </div>
                <div class="location-info" *ngIf="session.locationName">
                  <mat-icon>location_on</mat-icon>
                  <span>{{ session.locationName }}</span>
                </div>
              </div>
              <div class="session-actions">
                <button mat-icon-button color="primary" (click)="onEditSession(session, data)"
                  [title]="'Edit' | translate">
                  <mat-icon>edit</mat-icon>
                </button>
                <button mat-icon-button color="warn" (click)="onDeleteSession(session, data)"
                  [title]="'Delete' | translate">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
            </div>
          </div>

          <div class="total-summary glass-card mt-3">
            <div class="summary-item">
              <label>{{ 'TotalSessions' | translate }}:</label>
              <span>{{ data.sessionsCount }}</span>
            </div>
            <div class="summary-item">
              <label>{{ 'TotalHours' | translate }}:</label>
              <span>{{ data.totalWorkedHours | number: '1.2-2' }}</span>
            </div>
          </div>
        </div>

        <div class="dialog-footer">
          <button mat-button mat-dialog-close class="btn btn-secondary">{{ 'Close' | translate }}</button>
        </div>
      </div>
    </ng-template>

    <!-- Pagination -->
    <app-pagination *ngIf="!store.isLoading() && !store.error() && filteredAttendances().length > 0"
      [totalCount]="store.totalCount()" [request]="store.request()" (pageChange)="onPageChange($event)">
    </app-pagination>
  </div>

  <!-- Mobile Bottom Sheet Filter -->
  <div *ngIf="isMobile" class="mobile-bottom-sheet" [class.open]="!isFilterCollapsed">
    <!-- Backdrop -->
    <div class="bottom-sheet-backdrop" (click)="closeMobileFilter()"></div>

    <!-- Bottom Sheet Content -->
    <div class="bottom-sheet-content">
      <!-- Handle Bar -->
      <div class="bottom-sheet-handle" (click)="toggleFilter()"></div>

      <!-- Filter Header -->
      <div class="bottom-sheet-header">
        <h5>{{ 'Filters' | translate }}</h5>
        <button class="btn-close" (click)="closeMobileFilter()">
          <fa-icon [icon]="faFilter"></fa-icon>
        </button>
      </div>

      <!-- Filter Form -->
      <div class="bottom-sheet-body">
        <form [formGroup]="filterForm" (ngSubmit)="onFilter()" class="mobile-filters-form">
          <div class="form-group">
            <label>{{ 'Date' | translate }}</label>
            <input type="date" class="form-control" formControlName="date" [placeholder]="'Date' | translate">
          </div>

          <div class="form-group">
            <label>{{ 'EmployeeName' | translate }}</label>
            <input type="text" class="form-control" formControlName="employeeName"
              [placeholder]="'EmployeeName' | translate">
          </div>

          <div class="mobile-filter-buttons">
            <button type="submit" class="btn btn-primary btn-full">
              {{ 'ApplyFilters' | translate }}
            </button>
            <button type="button" class="btn btn-secondary btn-full" (click)="onResetFilters()">
              {{ 'Reset' | translate }}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Monthly Worked Hours Dialog Template -->
  <ng-template #monthlyHoursDialogTemplate let-data>
    <div class="monthly-hours-dialog">
      <div class="dialog-header">
        <h3>
          <mat-icon>calculate</mat-icon>
          {{ 'MonthlyWorkedHours' | translate }}
        </h3>
        <p class="subtitle">{{ data.employeeName }}</p>
      </div>

      <div class="dialog-content">
        <!-- Loading State -->
        <div *ngIf="monthlyHoursStore.isLoading()" class="state-container loading-state">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p>{{ 'CalculatingHours' | translate }}...</p>
        </div>

        <!-- Error State -->
        <div *ngIf="monthlyHoursStore.error()" class="state-container error-state">
          <mat-icon class="error-icon">error_outline</mat-icon>
          <p class="error-msg">{{ monthlyHoursStore.error() }}</p>
          <button class="btn btn-outline-primary btn-sm mt-2"
            (click)="monthlyHoursStore.loadMonthlyHours(data.employeeId)">
            {{ 'Retry' | translate }}
          </button>
        </div>

        <!-- Success State -->
        <div *ngIf="monthlyHoursStore.isSuccess() && monthlyHoursStore.data()" class="state-container success-state">
          <div class="hours-display glass-card">
            <div class="hours-value">
              {{ formatHoursToHHMM(monthlyHoursStore.data()?.totalWorkedHours || 0) }}
            </div>
            <div class="hours-label">{{ 'Hours' | translate }}</div>
          </div>

          <div class="period-info mt-3">
            <span class="badge bg-light text-dark">
              {{ monthlyHoursStore.data()?.month }}/{{ monthlyHoursStore.data()?.year }}
            </span>
          </div>

          <p class="success-msg mt-3 text-success">
            <mat-icon inline>check_circle</mat-icon>
            {{ 'CalculationComplete' | translate }}
          </p>
        </div>
      </div>

      <div class="dialog-footer">
        <button mat-button mat-dialog-close class="btn btn-secondary" (click)="monthlyHoursStore.resetState()">
          {{ 'Close' | translate }}
        </button>
      </div>
    </div>
  </ng-template>
</div>