<div class="employee-salaries-container">
  <div class="container-fluid">
    <!-- Header Section -->
    <div class="page-header">
      <div class="header-content">
        <button class="btn-back" routerLink="/admin/financial">
          <fa-icon [icon]="faArrowLeft"></fa-icon>
        </button>
        <div class="header-text">
          <h1 class="page-title">
            <fa-icon [icon]="faDollarSign" class="title-icon"></fa-icon>
            {{ 'EmployeeSalaries' | translate }}
          </h1>
          <p class="page-subtitle">{{ 'ManageEmployeeSalaryConfigurations' | translate }}</p>
        </div>
      </div>
      <button class="btn-primary-action" (click)="openCreateDialog()">
        <fa-icon [icon]="faPlus" class="me-2"></fa-icon>
        <span>{{ 'AddSalary' | translate }}</span>
      </button>
    </div>

    <!-- Stats Overview -->
    <div class="stats-grid">
      <div class="stat-card stat-card-primary">
        <div class="stat-icon-wrapper">
          <fa-icon [icon]="faUsers" class="stat-icon"></fa-icon>
        </div>
        <div class="stat-content">
          <div class="stat-value">{{ totalSalaries }}</div>
          <div class="stat-label">{{ 'TotalSalaries' | translate }}</div>
        </div>
      </div>

      <div class="stat-card stat-card-success">
        <div class="stat-icon-wrapper">
          <fa-icon [icon]="faCalendarAlt" class="stat-icon"></fa-icon>
        </div>
        <div class="stat-content">
          <div class="stat-value">{{ monthlySalaries }}</div>
          <div class="stat-label">{{ 'MonthlySalaries' | translate }}</div>
        </div>
      </div>

      <div class="stat-card stat-card-info">
        <div class="stat-icon-wrapper">
          <fa-icon [icon]="faClock" class="stat-icon"></fa-icon>
        </div>
        <div class="stat-content">
          <div class="stat-value">{{ hourlySalaries }}</div>
          <div class="stat-label">{{ 'HourlySalaries' | translate }}</div>
        </div>
      </div>

      <div class="stat-card stat-card-warning">
        <div class="stat-icon-wrapper">
          <fa-icon [icon]="faDollarSign" class="stat-icon"></fa-icon>
        </div>
        <div class="stat-content">
          <div class="stat-value">{{ totalAmount | number:'1.0-0' }}</div>
          <div class="stat-label">{{ 'TotalBaseSalaries' | translate }} (EGP)</div>
        </div>
      </div>
    </div>

    <!-- Main Content Card -->
    <div class="content-card">
      <!-- Filters Bar -->
      <div class="filters-section">
        <div class="search-box">
          <fa-icon [icon]="faSearch" class="search-icon"></fa-icon>
          <input 
            type="text" 
            class="search-input" 
            [(ngModel)]="searchTerm"
            (ngModelChange)="onSearchChange()"
            [placeholder]="'SearchByEmployeeName' | translate"
          />
        </div>

        <div class="filter-group">
          <select class="filter-select" [(ngModel)]="filterSalaryType" (ngModelChange)="onFilterChange()">
            <option [ngValue]="null">{{ 'AllSalaryTypes' | translate }}</option>
            <option value="PerMonth">{{ 'PerMonth' | translate }}</option>
            <option value="PerDay">{{ 'PerDay' | translate }}</option>
            <option value="PerHour">{{ 'PerHour' | translate }}</option>
            <option value="Custom">{{ 'Custom' | translate }}</option>
          </select>

          <select class="filter-select" [(ngModel)]="pageSize" (ngModelChange)="onPageSizeChange()">
            <option [value]="5">5</option>
            <option [value]="10">10</option>
            <option [value]="20" selected>20</option>
            <option [value]="50">50</option>
            <option [value]="100">100</option>
          </select>

          <button class="btn-reset" (click)="resetFilters()" [title]="'Reset' | translate">
            <fa-icon [icon]="faRedo"></fa-icon>
          </button>
        </div>
      </div>

      <!-- Loading State -->
      <div *ngIf="loading" class="loading-state">
        <div class="spinner-wrapper">
          <div class="spinner"></div>
          <p>{{ 'Loading' | translate }}...</p>
        </div>
      </div>

      <!-- Salaries List -->
      <div *ngIf="!loading && salaries.length > 0" class="salaries-list">
        <div class="salary-card" *ngFor="let salary of salaries; let i = index">
          <div class="salary-header">
            <div class="employee-info">
              <div class="employee-avatar">
                <fa-icon [icon]="faUser"></fa-icon>
              </div>
              <div class="employee-details">
                <h3 class="employee-name">{{ salary.employeeName }}</h3>
                <span class="salary-type-badge" [ngClass]="getSalaryTypeBadgeClass(salary.salaryType)">
                  {{ ('SalaryType_' + getSalaryTypeString(salary.salaryType)) | translate }}
                </span>
              </div>
            </div>
            <div class="salary-actions">
              <button class="btn-icon btn-create-report" (click)="openCreateReportDialog(salary)" [title]="'CreateSalaryReport' | translate">
                <fa-icon [icon]="faCalculator"></fa-icon>
              </button>
              <button class="btn-icon btn-edit" (click)="openUpdateDialog(salary)" [title]="'Edit' | translate">
                <fa-icon [icon]="faEdit"></fa-icon>
              </button>
              <button class="btn-icon btn-delete" (click)="confirmDelete(salary)" [title]="'Delete' | translate">
                <fa-icon [icon]="faTrash"></fa-icon>
              </button>
            </div>
          </div>

          <div class="salary-body">
            <div class="salary-info-grid">
              <div class="info-item">
                <span class="info-label">{{ 'Amount' | translate }}</span>
                <span class="info-value amount-value">{{ salary.amount | number:'1.2-2' }} EGP</span>
              </div>

              <div class="info-item" *ngIf="salary.hourlyRate">
                <span class="info-label">{{ 'HourlyRate' | translate }}</span>
                <span class="info-value">{{ salary.hourlyRate | number:'1.2-2' }} EGP</span>
              </div>

              <div class="info-item" *ngIf="salary.overtimeRate">
                <span class="info-label">{{ 'OvertimeRate' | translate }}</span>
                <span class="info-value">{{ salary.overtimeRate | number:'1.2-2' }} EGP</span>
              </div>

              <div class="info-item full-width" *ngIf="salary.notes">
                <span class="info-label">{{ 'Notes' | translate }}</span>
                <span class="info-value notes-value">{{ salary.notes }}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Pagination -->
        <div class="pagination" *ngIf="totalPages > 1">
          <button 
            class="pagination-btn" 
            [disabled]="currentPage === 1"
            (click)="goToPage(currentPage - 1)">
            <fa-icon [icon]="faChevronLeft"></fa-icon>
          </button>
          
          <div class="pagination-info">
            <span class="current-page">{{ currentPage }}</span>
            <span class="separator">/</span>
            <span class="total-pages">{{ totalPages }}</span>
          </div>
          
          <button 
            class="pagination-btn" 
            [disabled]="currentPage === totalPages"
            (click)="goToPage(currentPage + 1)">
            <fa-icon [icon]="faChevronRight"></fa-icon>
          </button>
        </div>
      </div>

      <!-- Empty State -->
      <div *ngIf="!loading && salaries.length === 0" class="empty-state">
        <div class="empty-icon">
          <fa-icon [icon]="faDollarSign"></fa-icon>
        </div>
        <h3>{{ 'NoSalariesFound' | translate }}</h3>
        <p>{{ 'StartByAddingEmployeeSalary' | translate }}</p>
        <button class="btn-primary-action" (click)="openCreateDialog()">
          <fa-icon [icon]="faPlus" class="me-2"></fa-icon>
          {{ 'AddSalary' | translate }}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Create/Update Modal -->
<div class="modal-overlay" *ngIf="showDialog" (click)="closeDialog()">
  <div class="modal-container" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>
        <fa-icon [icon]="faDollarSign" class="me-2"></fa-icon>
        {{ (isEditMode ? 'UpdateSalary' : 'AddSalary') | translate }}
      </h2>
      <button class="btn-close" (click)="closeDialog()">
        <fa-icon [icon]="faTimes"></fa-icon>
      </button>
    </div>

    <div class="modal-body">
      <form class="salary-form">
        <!-- Employee Selection -->
        <div class="form-group" *ngIf="!isEditMode">
          <label class="form-label required">{{ 'Employee' | translate }}</label>
          <select class="form-control" [(ngModel)]="form.employeeId" name="employeeId" required>
            <option [ngValue]="null">{{ 'SelectEmployee' | translate }}</option>
            <option *ngFor="let emp of employees" [ngValue]="emp.id">{{ emp.name }}</option>
          </select>
        </div>

        <!-- Employee Name (Read-only in edit mode) -->
        <div class="form-group" *ngIf="isEditMode">
          <label class="form-label">{{ 'Employee' | translate }}</label>
          <input type="text" class="form-control" [value]="selectedSalary?.employeeName" readonly />
        </div>

        <!-- Salary Type -->
        <div class="form-group">
          <label class="form-label required">{{ 'SalaryType' | translate }}</label>
          <div class="salary-type-options">
            <label class="salary-type-option" [class.active]="form.salaryType === 1">
              <input type="radio" [(ngModel)]="form.salaryType" name="salaryType" [value]="1" (ngModelChange)="onSalaryTypeChange()" />
              <div class="option-content">
                <fa-icon [icon]="faCalendarAlt"></fa-icon>
                <span>{{ 'PerMonth' | translate }}</span>
              </div>
            </label>

            <label class="salary-type-option" [class.active]="form.salaryType === 0">
              <input type="radio" [(ngModel)]="form.salaryType" name="salaryType" [value]="0" (ngModelChange)="onSalaryTypeChange()" />
              <div class="option-content">
                <fa-icon [icon]="faCalendarAlt"></fa-icon>
                <span>{{ 'PerDay' | translate }}</span>
              </div>
            </label>

            <label class="salary-type-option" [class.active]="form.salaryType === 2">
              <input type="radio" [(ngModel)]="form.salaryType" name="salaryType" [value]="2" (ngModelChange)="onSalaryTypeChange()" />
              <div class="option-content">
                <fa-icon [icon]="faClock"></fa-icon>
                <span>{{ 'PerHour' | translate }}</span>
              </div>
            </label>

            <label class="salary-type-option" [class.active]="form.salaryType === 3">
              <input type="radio" [(ngModel)]="form.salaryType" name="salaryType" [value]="3" (ngModelChange)="onSalaryTypeChange()" />
              <div class="option-content">
                <fa-icon [icon]="faCog"></fa-icon>
                <span>{{ 'Custom' | translate }}</span>
              </div>
            </label>
          </div>
        </div>

        <!-- Amount (Base Salary) -->
        <div class="form-group">
          <label class="form-label" [class.required]="!isEditMode">{{ 'BaseSalaryAmount' | translate }} (EGP)</label>
          <div class="input-with-icon">
            <fa-icon [icon]="faDollarSign" class="input-icon"></fa-icon>
            <input 
              type="number" 
              class="form-control" 
              [(ngModel)]="form.amount" 
              name="amount"
              min="0"
              step="0.01"
              [required]="!isEditMode"
              [placeholder]="'EnterBaseSalaryAmount' | translate"
            />
          </div>
          <small class="form-text">{{ 'AmountConstraint' | translate }}</small>
        </div>

        <!-- Hourly Rate - Editable only for PerHour and Custom -->
        <div class="form-group">
          <label class="form-label">{{ 'HourlyRate' | translate }} (EGP)</label>
          <div class="input-with-icon">
            <fa-icon [icon]="faClock" class="input-icon"></fa-icon>
            <input 
              type="number" 
              class="form-control" 
              [(ngModel)]="form.hourlyRate" 
              name="hourlyRate"
              min="0"
              step="1"
              [placeholder]="'EnterHourlyRate' | translate"
              [readonly]="form.salaryType === 1 || form.salaryType === 0"
              [class.readonly-field]="form.salaryType === 1 || form.salaryType === 0"
            />
          </div>
          <small class="form-text" *ngIf="form.salaryType === 1 || form.salaryType === 0">
            {{ 'AutoCalculatedFromBaseSalary' | translate }}
          </small>
          <small class="form-text" *ngIf="form.salaryType !== 1 && form.salaryType !== 0">
            {{ 'HourlyRateConstraint' | translate }}
          </small>
        </div>

        <!-- Overtime Rate - Always editable -->
        <div class="form-group">
          <label class="form-label">{{ 'OvertimeRate' | translate }} (EGP)</label>
          <div class="input-with-icon">
            <fa-icon [icon]="faClock" class="input-icon"></fa-icon>
            <input 
              type="number" 
              class="form-control" 
              [(ngModel)]="form.overtimeRate" 
              name="overtimeRate"
              min="0"
              step="1"
              [placeholder]="'EnterOvertimeRate' | translate"
            />
          </div>
          <small class="form-text">{{ 'OvertimeRateConstraint' | translate }}</small>
        </div>

        <!-- Notes -->
        <div class="form-group">
          <label class="form-label">{{ 'Notes' | translate }}</label>
          <textarea 
            class="form-control" 
            [(ngModel)]="form.notes" 
            name="notes"
            rows="3"
            maxlength="300"
            [placeholder]="'EnterNotes' | translate"
          ></textarea>
          <small class="form-text text-muted">{{ form.notes.length || 0 }}/300 {{ 'CharactersMax' | translate }}</small>
        </div>
      </form>
    </div>

    <div class="modal-footer">
      <button class="btn-secondary" (click)="closeDialog()">
        {{ 'Cancel' | translate }}
      </button>
      <button 
        class="btn-primary-action" 
        (click)="saveSalary()"
        [disabled]="!isFormValid() || saving">
        <span *ngIf="saving" class="spinner-sm me-2"></span>
        {{ (isEditMode ? 'Update' : 'Create') | translate }}
      </button>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal-overlay modal-danger" *ngIf="showDeleteDialog" (click)="closeDeleteDialog()">
  <div class="modal-container modal-sm" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>
        <fa-icon [icon]="faExclamationTriangle" class="me-2"></fa-icon>
        {{ 'ConfirmDelete' | translate }}
      </h2>
      <button class="btn-close" (click)="closeDeleteDialog()">
        <fa-icon [icon]="faTimes"></fa-icon>
      </button>
    </div>

    <div class="modal-body">
      <p>{{ 'DeleteSalaryConfirmation' | translate:{ name: salaryToDelete?.employeeName } }}</p>
    </div>

    <div class="modal-footer">
      <button class="btn-secondary" (click)="closeDeleteDialog()">
        {{ 'Cancel' | translate }}
      </button>
      <button class="btn-danger" (click)="deleteSalary()" [disabled]="deleting">
        <span *ngIf="deleting" class="spinner-sm me-2"></span>
        {{ 'Delete' | translate }}
      </button>
    </div>
  </div>
</div>

<!-- Create Salary Report Modal -->
<div class="modal-overlay" *ngIf="showCreateReportDialog" (click)="closeCreateReportDialog()">
  <div class="modal-container" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>
        <fa-icon [icon]="faCalculator" class="me-2"></fa-icon>
        {{ 'CreateReportFor' | translate: {name: selectedEmployee?.employeeName || 'Employee #' + selectedEmployee?.employeeId} }}
      </h2>
      <button class="btn-close" (click)="closeCreateReportDialog()">
        <fa-icon [icon]="faTimes"></fa-icon>
      </button>
    </div>
    
    <div class="modal-body">
      <form (ngSubmit)="createSalaryReport()" #reportForm="ngForm">
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">{{ 'ReportMonth' | translate }}</label>
            <select 
              class="form-select" 
              [(ngModel)]="createReportForm.reportMonth" 
              name="reportMonth"
              required
            >
              <option value="">{{ 'SelectReportMonth' | translate }}</option>
              <option *ngFor="let month of monthOptions" [value]="month.value">
                {{ month.label | translate }}
              </option>
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label">{{ 'ReportYear' | translate }}</label>
            <select 
              class="form-select" 
              [(ngModel)]="createReportForm.reportYear" 
              name="reportYear"
              required
            >
              <option value="">{{ 'SelectReportYear' | translate }}</option>
              <option *ngFor="let year of yearOptions" [value]="year">
                {{ year }}
              </option>
            </select>
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">{{ 'ReportNotes' | translate }}</label>
          <textarea 
            class="form-control" 
            [(ngModel)]="createReportForm.notes" 
            name="notes"
            rows="3"
            maxlength="500"
            [placeholder]="'EnterReportNotes' | translate"
          ></textarea>
          <small class="form-text text-muted">{{ (createReportForm.notes || '').length }}/500 {{ 'CharactersMax' | translate }}</small>
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn-secondary" (click)="closeCreateReportDialog()">
            {{ 'Cancel' | translate }}
          </button>
          <button 
            type="submit" 
            class="btn-primary-action"
            [disabled]="!reportForm.form.valid || creatingReport"
          >
            <span *ngIf="creatingReport" class="spinner-sm me-2"></span>
            <fa-icon *ngIf="!creatingReport" [icon]="faCalculator" class="me-2"></fa-icon>
            {{ creatingReport ? ('CreatingReport' | translate) : ('GenerateReport' | translate) }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
