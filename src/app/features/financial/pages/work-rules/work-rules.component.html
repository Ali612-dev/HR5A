<div class="work-rules-container">
  <div class="container-fluid py-4">
    <!-- Header -->
    <div class="page-header">
      <div class="header-left">
        <button class="btn btn-ghost" routerLink="/admin/financial">
          <fa-icon [icon]="faArrowLeft" class="me-2"></fa-icon>
          {{ 'Back' | translate }}
        </button>
      </div>
      <div class="header-center">
        <div class="page-title">
          <fa-icon [icon]="faClock" class="me-2"></fa-icon>
          {{ 'WorkRules' | translate }}
        </div>
      </div>
      <div class="header-right">
        <div class="header-actions">
          <button class="btn btn-primary" (click)="showAddForm()">
            <fa-icon [icon]="faPlus" class="me-2"></fa-icon>
            {{ 'AddWorkRule' | translate }}
          </button>
        </div>
      </div>
    </div>

    <!-- Add/Edit Form - Removed, now using separate pages -->

    <!-- Content -->
    <div class="content-container">
      <ng-container *ngIf="isLoading; else loadedContent">
        <div class="glass-card h-100">
          <div class="glass-body p-4">
            <app-shimmer></app-shimmer>
          </div>
        </div>
      </ng-container>

      <ng-template #loadedContent>
        <div *ngIf="error" class="alert alert-danger error-widget" role="alert">
          <div class="error-content">
            <fa-icon [icon]="faTimes" class="error-icon"></fa-icon>
            <div class="error-message">
              <strong>{{ 'Error' | translate }}:</strong>
              <span>{{ error }}</span>
            </div>
            <button type="button" class="btn-close-error" (click)="error = null" aria-label="Close">
              <fa-icon [icon]="faTimes"></fa-icon>
            </button>
          </div>
        </div>

        <div *ngIf="!error" class="glass-card">
          <div class="glass-body p-4">
            <div class="work-rules-header d-flex align-items-center mb-4 flex-nowrap">
              <h5 class="mb-0 me-4 flex-shrink-0">{{ 'WorkRules' | translate }}</h5>
              <span class="badge bg-purple-accent me-3 flex-shrink-0">{{ totalCount }}</span>
              <span class="text-muted small flex-shrink-0">{{ 'TotalRules' | translate }}</span>
            </div>

            <div *ngIf="workRules.length > 0; else noWorkRules" class="rules-grid">
              <div *ngFor="let rule of workRules" class="rule-card">
                <div class="rule-header">
                  <div class="rule-title">
                    <h6 class="mb-1">{{ rule.category }}</h6>
                    <div class="d-flex align-items-center gap-2 mb-2">
                      <span class="badge bg-primary work-rule-category-badge">{{
                        getWorkRuleCategoryLabelArabic(rule.category) }}</span>
                      <span class="badge bg-light-purple work-rule-type-badge">{{ getWorkRuleTypeLabelArabic(rule.type)
                        }}</span>
                    </div>
                  </div>
                  <div class="rule-actions">
                    <div class="dropdown" #actionMenu>
                      <button class="btn btn-menu-toggle" type="button" (mousedown)="toggleActionMenu($event, rule.id)"
                        (click)="$event.stopPropagation()" title="{{ 'Actions' | translate }}">
                        <fa-icon [icon]="faEllipsisVertical"></fa-icon>
                      </button>
                      <div class="dropdown-menu" [class.show]="activeMenuId === rule.id"
                        (click)="$event.stopPropagation()">
                        <button class="dropdown-item"
                          [routerLink]="['/admin/financial/work-rules', rule.id, 'details']">
                          <fa-icon [icon]="faEye" class="me-2"></fa-icon>
                          {{ 'ViewDetails' | translate }}
                        </button>
                        <button class="dropdown-item" (click)="openAssignDialog(rule)">
                          <fa-icon [icon]="faUserTie" class="me-2"></fa-icon>
                          {{ 'Assign' | translate }}
                        </button>
                        <button class="dropdown-item" (click)="showEditForm(rule)">
                          <fa-icon [icon]="faEdit" class="me-2"></fa-icon>
                          {{ 'Edit' | translate }}
                        </button>
                        <div class="dropdown-divider"></div>
                        <button class="dropdown-item text-danger" [disabled]="isDeletingRule(rule.id)"
                          (click)="deleteWorkRule(rule)">
                          <fa-icon [icon]="isDeletingRule(rule.id) ? faSpinner : faTrash"
                            [class.fa-spin]="isDeletingRule(rule.id)" class="me-2"></fa-icon>
                          {{ isDeletingRule(rule.id) ? ('Deleting' | translate) : ('Delete' | translate) }}
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="rule-description">
                  <p class="mb-2">{{ (rule.description && rule.description !== 'string') ? rule.description : '-' }}</p>
                  <div class="rule-details">
                    <div class="row g-2">
                      <div class="col-6" *ngIf="rule.expectStartTime">
                        <small class="text-muted">
                          <fa-icon [icon]="faClock" class="me-1"></fa-icon>
                          {{ 'Start' | translate }}: {{ formatTime(rule.expectStartTime) }}
                        </small>
                      </div>
                      <div class="col-6" *ngIf="rule.expectEndTime">
                        <small class="text-muted">
                          <fa-icon [icon]="faClock" class="me-1"></fa-icon>
                          {{ 'End' | translate }}: {{ formatTime(rule.expectEndTime) }}
                        </small>
                      </div>
                      <div class="col-6" *ngIf="rule.expectedHoursPerDay">
                        <small class="text-muted">
                          {{ 'HoursPerDay' | translate }}: {{ rule.expectedHoursPerDay }}
                        </small>
                      </div>
                      <div class="col-6" *ngIf="rule.expectedDaysPerWeek">
                        <small class="text-muted">
                          {{ 'DaysPerWeek' | translate }}: {{ rule.expectedDaysPerWeek }}
                        </small>
                      </div>
                    </div>
                  </div>
                  <div class="rule-footer">
                    <small class="text-muted">
                      <fa-icon [icon]="faUsers" class="me-1"></fa-icon>
                      {{ rule.employeeCount }} {{ 'Employees' | translate }}
                    </small>
                    <div class="rule-status">
                      <span class="badge" [ngClass]="rule.isPrivate ? 'bg-warning' : 'bg-success'">
                        {{ rule.isPrivate ? ('Private' | translate) : ('Public' | translate) }}
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <ng-template #noWorkRules>
              <div class="text-center py-5">
                <fa-icon [icon]="faClock" class="display-1 text-muted mb-3"></fa-icon>
                <h5 class="text-muted">{{ 'NoWorkRules' | translate }}</h5>
                <p class="text-muted">{{ 'CreateYourFirstWorkRule' | translate }}</p>
                <button class="btn btn-primary" (click)="showAddForm()">
                  <fa-icon [icon]="faPlus" class="me-2"></fa-icon>
                  {{ 'AddWorkRule' | translate }}
                </button>
              </div>
            </ng-template>
          </div>
        </div>
      </ng-template>
    </div>
  </div>
</div>